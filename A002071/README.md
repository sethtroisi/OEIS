# [A002071](https://oeis.org/A002071)

Related
[A002072](https://oeis.org/A002072)
and
[Project Euler 581](https://projecteuler.net/problem=581)

[Blog Post with larger records](https://11011110.github.io/blog/2007/03/23/smooth-pairs.html)
And
[Lehmer's "On a Problem of Stormer's" Paper](https://scispace.com/pdf/on-a-problem-of-stormer-2mpsudvm07.pdf)

## Compile and run

```
g++ -O2 --std=c++23 -o A002071 A002071.cpp -l gmpxx -lgmp -fopenmp
time ./A002071 97


g++ -g -O2 --std=c++23 -o A002071_exact A002071_exact.cpp -l gmpxx -lgmp -fopenmp
time ./A002071 61 13'000'000

# GPU stuff
nvcc -g -I../../CGBN/include/cgbn -lgmp  --compiler-bindir gcc -I/usr/local/cuda/include   --generate-code arch=compute_61,code=sm_61 --ptxas-options=-v --compiler-options -fno-strict-aliasing -O2 -o cgbn_compute_cf.lo -c cgbn_compute_cf.cu

```

## Comparison

```
cat t | awk '{$16=$18=""; print $0}' | sed 's/  \+/ /g'
```


## Improvements

1. Lehmer uses `Fib(K)` as a lower bound on the size of the continued fraction.
   Something like `exp(sum(log(k_i)))` would enable avoiding 75%+ of expansion.

1. PQa to solve Pell Equations is 2-3x slower.
   * The continued fraction (CF) approach gets to do most of it's math in `__uint128_t`
      * The `uint128_t` code is 10x faster than the `mpz_class` code!
      * At `P=73` with `log2(prod(primes(73))) = 95`, 90% of `D` are < 64 bits.
      * At `P=97` with `log2(prod(primes(73))) = 95`, 50% of `D` are < 64 bits.
      * At `P=131` >99.7% of `D` are < 127 bits and on the fast path!
      * Maybe at `P=151` we'd have a few percent but that's still a LOT of fast path.

1. Found should be written to disk.

1. Write varients of all code for uint64, uint128 and try to stay in the uint64 path for expand, test, ...

1. Implement `continued_fraction_sqrt_126_pessimistic` on the GPU using CGBN. runs 1024 `D` at the same time.
   Returns the indexes where a == two_a during `MAX_CF` iterations. Those get re-run and tested on CPU.

1. For exact it seems that memory is allocating and deallocating a lot.

1. Can you expand CF to 50% + 20 and check if a palindrome has started? if not stop, if palindrome is possible continue
   * Expect 80% of the time to quit after reading the first 50% of the array. Reading is 3x faster than doing the modulo?

1. Instead of counting the sum of smooth factors could try to see if there's some prime factor > P
   * Currently for P=151 needs 11 expansions to check sum of smooth factors.
   * In 11 expCould test for >44 primes, only gives 20-40% chance of finding a factor. Not worth it.

Tried

1. Write `continued_fraction_sqrt_126_pessimistic` which assumes CF > MAX_CF and avoids the array write.
   * Doesn't save anytime to not write to the array.

## Results

```
n  P     total max                     total-exact max-exact                    total1 max1                   total1-exact max1-exact                   total2 max2                   total2-exact max2-exact               total1-sqr max1-sqr                 total1-tri max1-tri
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
1  2         1 2                                 1 2                                 1 1                                 1 1                                 0 0                                 0 0                                 0 0                                 0 0
2  3         5 16                                4 16                                4 8                                 3 8                                 1 1                                 1 1                                 2 8                                 1 2
3  5        13 160                               8 160                              10 80                                6 80                                3 25                                2 25                                5 80                                3 9
4  7        29 8748                             16 8748                             23 4374                             13 4374                              6 243                               3 243                              10 2400                              7 35
5  11       49 19600                            20 19600                            40 9800                             17 9800                              9 243                               3 75                               15 9800                              9 54
6  13       83 246400                           34 246400                           68 123200                           28 123200                           15 1573                              6 1573                             24 123200                           16 2079
7  17      130 672280                           47 672280                          108 336140                           40 336140                           22 2023                              7 2023                             34 194480                           22 2079
8  19      202 23718420                         72 23718420                        167 11859210                         59 11859210                         35 3969                             13 3969                             46 5909760                          29 14364
9  23      297 23718420                         95 10285000                        241 11859210                         74 5142500                          56 1447873                          21 1447873                          57 5909760                          35 52325
10 29      423 354365440                       126 354365440                       345 177182720                       104 177182720                        78 26578123                         22 26578123                         74 177182720                        39 52325
11 31      591 3222617398                      168 3222617398                      482 1611308699                      137 1611308699                      109 287080365                        31 287080365                        90 181037024                        50 1154439
12 37      799 9447152317                      208 9447152317                      653 3463199999                      171 3463199999                      146 9447152317                       37 9447152317                      114 308915775                        57 1154439
13 41     1061 127855050750                    262 127855050750                    869 63927525375                     216 63927525375                     192 9447152317                       46 2470954913                      141 45105689160                      68 1413720
14 43     1404 842277599278                    343 842277599278                   1153 421138799639                    284 421138799639                    251 9447152317                       59 1181631185                      174 45105689160                      84 59181759
15 47     1837 2218993446250                   433 2218993446250                  1502 1109496723125                   349 1109496723125                   335 9447152317                       84 4768304959                      208 45105689160                     100 154466675
16 53     2344 2907159732048                   507 2907159732048                  1930 1453579866024                   428 1453579866024                   414 9447152317                       79 907922169                       244 1453579866024                   112 154466675
17 59     2978 41257182408960                  634 41257182408960                 2454 20628591204480                  524 20628591204480                  524 122187528125                    110 122187528125                    287 1453579866024                   127 154466675
18 61     3777 63774701665792                  799 63774701665792                 3106 31887350832896                  652 31887350832896                  671 122187528125                    147 37517343435                     334 1453579866024                   151 154466675
19 67     4753 63774701665792                  976 25640240468750                 3896 31887350832896                  790 12820120234375                  857 932784765625                    186 932784765625                    387 4076276202440                   167 154466675
20 71     5899 238178082107392                1146 238178082107392                4839 119089041053696                 943 119089041053696                1060 932784765625                    203 430188203733                    433 15520834243200                  186 154466675
21 73     7338 4573663454608288               1439 4573663454608288               6040 2286831727304144               1201 2286831727304144               1298 2704807796873                   238 2704807796873                   494 15520834243200                  204 2465810424
22 79     9036 19182937474703818750           1698 19182937474703818750           7441 9591468737351909375            1401 9591468737351909375            1595 6774628298373                   297 6774628298373                   561 239438764968480                 230 2465810424
23 83    11118 19182937474703818750           2082 34903240221563712              9179 9591468737351909375            1738 17451620110781856              1939 473599589105797                 344 473599589105797                 635 239438764968480                 253 4755611574
24 89    13489 19182937474703818750           2371 332110803172167360            11134 9591468737351909375            1955 166055401586083680             2355 473599589105797                 416 211089142289023                 709 166055401586083680              275 4755611574
25 97    16223 19182937474703818750           2734 99913980938200000             13374 9591468737351909375            2240 49956990469100000              2849 473599589105797                 494 151377426693205                 787 166055401586083680              304 4755611574
26 101   19583 19182937474703818750           3360 8216517931479010998           16167 9591468737351909375            2793 4108258965739505499            3416 30945502301275315               567 30945502301275315               871 166055401586083680              327 4755611574
27 103   23605 38632316754147847668000        4022 38632316754147847668000       19507 19316158377073923834000        3340 19316158377073923834000        4098 30945502301275315               682 2728575616834375                973 19316158377073923834000         354 25278199127
28 107   28242 38632316754147847668000        4637 773079686222382448            23367 19316158377073923834000        3860 386539843111191224             4875 30945502301275315               777 15562980136200913              1096 19316158377073923834000         394 25278199127
29 109   33817 38632316754147847668000        5575 181101212761682433220         27949 19316158377073923834000        4582 90550606380841216610           5868 31584322190711673               993 31584322190711673              1227 19316158377073923834000         432 187493303340
30 113   40241 38632316754147847668000        6424 410284126426376207278         33233 19316158377073923834000        5284 205142063213188103639          7008 95281435950754443              1140 95281435950754443              1355 19316158377073923834000         462 187493303340
31 127   47509 38632316754147847668000        7268 106469590255765459648         39283 19316158377073923834000        6050 53234795127882729824           8226 767308615386551775             1218 767308615386551775             1498 19316158377073923834000         496 119719374747335
32 131   55860 38632316754147847668000        8351 8228608891233272032062        46166 19316158377073923834000        6883 4114304445616636016031         9694 6845433178730663473            1468 6845433178730663473            1619 19316158377073923834000         529 119719374747335
33 137   65521 248451871690466638878346       9661 248451871690466638878346      54150 124225935845233319439173       7984 124225935845233319439173      11371 6845433178730663473            1677 3425684783380442539            1773 19316158377073923834000         551 119719374747335
34 139   76715 248451871690466638878346      11194 6964871068650677061878        63428 124225935845233319439173       9278 3482435534325338530939        13287 18057847376737430689           1916 18057847376737430689           1931 19316158377073923834000         584 119719374747335
35 149   89528 248451871690466638878346      12813 12837739470504278738418       74007 124225935845233319439173      10579 6418869735252139369209        15521 70966896073184986875           2234 70966896073184986875           2096 19316158377073923834000         616 119719374747335
36 151  104164 248451871690466638878346      14636 11875421535631980269790       86125 124225935845233319439173      12118 5937710767815990134895        18039 3263553601598145459373         2518 3263553601598145459373         2274 19316158377073923834000         657 119719374747335
```

Exact results
```
n  P     total max                   total-exact max-exact                  total1 max1                   longest CF D
-------------------------------------------------------------------------------------------------------------------------------
0  2         1 2                               1 2                               1 1                               2 2
1  3         5 16                              4 16                              4 8                               2 2
2  5        13 160                             8 160                            10 80                              2 2
3  7        29 8748                           16 8748                           23 4374                            6 21
4  11       49 19600                          20 19600                          40 9800                           16 385
5  13       83 246400                         34 246400                         68 123200                         18 5005
6  17      130 672280                         47 672280                        108 336140                         34 3094
7  19      202 23718420                       72 23718420                      167 11859210                       66 461890
8  23      297 23718420                       95 10285000                      241 11859210                      136 2124694
9  29      423 354365440                     126 354365440                     345 177182720                     522 215656441
10 31      591 3222617398                    168 3222617398                    482 1611308699                   1262 66853496710
11 37      799 9447152317                    208 9447152317                    653 3463199999                   4178 2473579378270
12 41     1061 127855050750                  262 127855050750                  869 63927525375                 16090 7244053893505
13 43     1404 842277599278                  343 842277599278                 1153 421138799639                35976 436092044389001
14 47     1837 2218993446250                 433 2218993446250                1502 1109496723125              173996 2928046583754721
15 53     2344 2907159732048                 507 2907159732048                1930 1453579866024              546544 310372937878000426
16 59     2978 41257182408960                634 41257182408960               2454 20628591204480            1648042 64092011671807087969
17 61     3777 63774701665792                799 63774701665792               3106 31887350832896           12524702 3909612711980232366109
18 67     4753 63774701665792                976 25640240468750               3896 31887350832896           38668246 37420578814667938361329
19 71     5899 238178082107392              1146 238178082107392              4839 119089041053696         105675354 241532826894674874877669
20 73     7338 4573663454608288             1439 4573663454608288             6040 2286831727304144        755686000 6788280099874837358436887245
```

Note 73 requires solving `x^2 - 6788280099874837358436887245*y^2 = 1` which involves expanding the continued fraction of that number which
 has a period of 755,686,001 (a mercifully even repeating length)!


### Runtime

On 20250913 running `A002071`
```
103 took 1/13 minutes
107 took 3/27 minutes
109 took 5/56 minutes
113 took 12/118 minutes
```

On 20250912 running `A002071_exact` it took 240 total minutes to exactly solve 73.

On 20250910 running with `OMP_NUM_THREADS=10`
```
113 took 14/124 minutes
127 took 25/265 minutes
131 took 63/571 minutes
137 took 141/1261 minutes
```

At previous dates (~20250906)
```
149 was run twice with slightly different code | first run: 1207/12063 minutes, second run: 635/6349 minutes
151 took 1573/15714 minutes, took ~900 to finish 149 (reflecting the slightly higher MAX_CF limit)
```
